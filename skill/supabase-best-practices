# Supabase Best Practices

Comprehensive guide for Supabase development covering database design, security, performance, and patterns for React applications.

## Database Design

### Table Naming

Use snake_case for table and column names:
```sql
CREATE TABLE daily_habits (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date DATE NOT NULL,
  am_squats BOOLEAN DEFAULT false,
  steps_7k BOOLEAN DEFAULT false,
  bike_1hr BOOLEAN DEFAULT false,
  pm_squats BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Relationships

Use foreign keys for relational data:
```sql
CREATE TABLE workout_exercises (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  workout_id BIGINT REFERENCES workouts(id) ON DELETE CASCADE,
  exercise_id BIGINT REFERENCES exercises(id),
  sets INT NOT NULL,
  reps INT NOT NULL,
  rest_seconds INT,
  sort_order INT DEFAULT 0
);
```

### Indexes

Add indexes for frequently queried columns:
```sql
CREATE INDEX idx_daily_habits_date ON daily_habits(date);
CREATE INDEX idx_workout_logs_date ON workout_logs(date);
CREATE INDEX idx_workout_logs_exercise ON workout_logs(exercise_name);
```

## Security (Row Level Security)

### Always Enable RLS

```sql
ALTER TABLE daily_habits ENABLE ROW LEVEL SECURITY;
ALTER TABLE workout_logs ENABLE ROW LEVEL SECURITY;
```

### Policies

For public apps with anonymous access:
```sql
CREATE POLICY "Allow public access" ON daily_habits
  FOR ALL USING (true);
```

## Performance Optimization

### Select Only Needed Columns

**Instead of:**
```typescript
const { data } = await supabase.from('workouts').select('*')
```

**Prefer:**
```typescript
const { data } = await supabase
  .from('workouts')
  .select('id, name, workout_type')
```

### Loader Parallelization

Fetch independent data concurrently with `Promise.all`:
```typescript
loader: async () => {
  const [habitsResult, workoutResult] = await Promise.all([
    supabase.from('daily_habits').select('*').eq('date', dateStr).single(),
    supabase.from('workouts').select('*').eq('day_of_week', dayName).single()
  ])
  
  return { 
    habits: habitsResult.data, 
    workout: workoutResult.data 
  }
}
```

### Join Optimization

Use foreign table relationships efficiently:
```typescript
const { data } = await supabase
  .from('workouts')
  .select(`
    *,
    workout_exercises (
      id,
      sets,
      reps,
      exercises (
        name,
        muscle_group
      )
    )
  `)
  .eq('day_of_week', 'Monday')
```

## React Patterns

### Error Handling

```typescript
const { data, error } = await supabase.from('table').select()

if (error) {
  console.error('Supabase error:', error)
  throw error
}

return data
```

### Real-time Subscriptions

```typescript
useEffect(() => {
  const channel = supabase
    .channel('table_changes')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'daily_habits' },
      (payload) => {
        console.log('Change received:', payload)
      }
    )
    .subscribe()

  return () => {
    supabase.removeChannel(channel)
  }
}, [])
```

### Offline Support

Store pending operations in localStorage/IndexedDB:
```typescript
const saveOffline = async (operation) => {
  const pending = JSON.parse(localStorage.getItem('pending_ops') || '[]')
  pending.push({ ...operation, timestamp: Date.now() })
  localStorage.setItem('pending_ops', JSON.stringify(pending))
}
```

## When to Apply

- Database schema design
- Writing Supabase queries
- Implementing RLS policies
- Performance optimization
- Offline-first features
- Real-time subscriptions
